jQuery(function(c){var t,n=c("#settings"),i=c("#ncwm-main-process .ncwm-progress-m .tab.active"),r=c("#ncwm-error-messages"),s="",a="",l=c('input[name="controller"]').val(),o=3;sendAjaxRequestApp=function(e){return c.ajax({url:ncwm_ajax_request_params.ajax_app_url,type:"POST",data:e,dataType:"application/json json"})},sendAjaxRequestStore=function(e){return e.action="ncwm_migration",c.ajax({url:ncwm_ajax_request_params.ajax_wp_url,type:"POST",data:e,dataType:"json"})},isUrl=function(e){return/(http|ftp|https):\/\//.test(e)},escapeHtml=function(e){return e.replace(/[\"&'\/<>]/g,function(e){return{'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#47;","<":"&lt;",">":"&gt;"}[e]})},changeTab=function(e){var t,n;"next"==e?(t=i.next().next(),n=i.next(),i.removeClass("active"),i.addClass("done"),n.addClass("done")):(t=i.prev().prev(),n=i.prev(),i.removeClass("active"),n.removeClass("done"),t.removeClass("done")),t.addClass("active"),i=t},checkSelectEntity=function(){if(c(".list-entities input:checkbox:checked").length<1){c(".condition-entity").addClass("error");var e,t=c(".condition-entity").closest(".form-field").find("> .section-title");return t.hasClass("collapsed")&&(e=t.next(".list-field"),t.removeClass("collapsed"),e.slideDown()),!1}return c(".condition-entity").removeClass("error"),!0},checkSeparateLang=function(){if(c(".condition-language").length<1)return!0;if(isDupplicate(".language-list select")){c(".condition-language").addClass("error");var e,t=c(".condition-language").closest(".form-field").find("> .section-title");return t.hasClass("collapsed")&&(e=t.next(".list-field"),t.removeClass("collapsed"),e.slideDown()),!1}return c(".condition-language").removeClass("error"),!0},isDupplicate=function(e){var i=[],s=!1;return c(e).each(function(e,t){var n=c(t).val();if(-1!==c.inArray(n,i))return!(s=!0);0!==n&&i.push(n)}),i.length<1&&(s=!0),s},showUploading=function(e){e?(c(".uploading-file i").addClass("loading"),c(".uploading-file").slideDown()):(c(".uploading-file i").removeClass("loading"),c(".uploading-file").slideUp())},showInserting=function(e){e?(c(".creating-table i").addClass("loading"),c(".creating-table").slideDown()):(c(".creating-table i").removeClass("loading"),c(".creating-table").slideUp())},setIsRunningState=function(e){var t=c(".migration-loading");e?(t.removeClass("paused"),a="running"):(t.addClass("paused"),a="paused",setCurrentState("Paused!"))},setCurrentState=function(e){c(".source-target-processing-state").text(e)},showClearShop=function(e){e?setCurrentState("Clearing target store..."):setCurrentState("Processing...")},showIndexShop=function(e){e?setCurrentState("Indexing target store..."):setCurrentState("Finished!")},displayReponse=function(e,t,n,i,s){var a=c("#migrate-"+e+" span.migrate-bar-perc"),o=c("#migrate-"+e+" span.migrated"),r=c("#migrate-"+e+" div.failed"),l=c("#migrate-"+e+" i.check-icon");0<a.length&&0<o.length&&(a.css({width:t+"%"}),o.text(n),r.text("Errors: "+i)),s&&l.show()},autoRetry=function(){0<o&&(t=setTimeout(function(){c("#ncwm-migrate-stuck").is(":visible")&&(c("#ncwm-migrate-try-again").trigger("click"),--o)},3e4))},insertData=function(){var n=c("#file-upload"),i=c("#setup-submit");sendAjaxRequestStore({controller:l,func:"insert"}).done(function(e){var t;e.error&&((t=c(e.error)).appendTo(r),r.slideDown(),setTimeout(function(){t.slideUp(400,function(){t.remove(),r.is(":empty")&&r.slideUp()})},1e4)),"success"==e.result?(showInserting(!1),c("#file-upload-form .uploading-success").slideDown(),n.removeClass("disable-a"),i.removeClass("disable-a")):"continue"==e.result?insertData():(showInserting(!1),c("#file-upload-form .uploading-fail").slideDown(),n.removeClass("disable-a"),i.removeClass("disable-a"))}).fail(function(e){r.empty(),r.html(e.responseText),r.slideDown(),showInserting(!1),c("#file-upload-form .uploading-fail").slideDown(),n.removeClass("disable-a"),i.removeClass("disable-a")})},clearShop=function(){if(s="clearShop","paused"==a)return!1;showClearShop(!0),sendAjaxRequestStore({controller:l,func:"clear"}).done(function(e){var t;e.error&&((t=c(e.error)).appendTo(r),r.slideDown(),setTimeout(function(){t.slideUp(400,function(){t.remove(),r.is(":empty")&&r.slideUp()})},1e4)),"success"==e.result?(showClearShop(!1),migrateEntity()):"continue"==e.result?clearShop():(setIsRunningState(!1),c("#ncwm-migrate-stuck").slideDown(),autoRetry())}).fail(function(e){r.empty(),r.html(e.responseText),r.slideDown(),setIsRunningState(!1),c("#ncwm-migrate-stuck").slideDown(),autoRetry()})},indexShop=function(){if(s="indexShop","paused"==a)return!1;showIndexShop(!0),sendAjaxRequestStore({controller:l,func:"reindex"}).done(function(e){var t;e.error&&((t=c(e.error)).appendTo(r),r.slideDown(),setTimeout(function(){t.slideUp(400,function(){t.remove(),r.is(":empty")&&r.slideUp()})},1e4)),"success"==e.result?(showIndexShop(!1),i.removeClass("active"),i.addClass("done"),c("#ncwm-migration-loading").fadeOut(),c("#ncwm-migrate-success").slideDown()):"continue"==e.result?indexShop():(setIsRunningState(!1),c("#ncwm-migrate-stuck").slideDown(),autoRetry())}).fail(function(e){r.empty(),r.html(e.responseText),r.slideDown(),setIsRunningState(!1),c("#ncwm-migrate-stuck").slideDown(),autoRetry()})},migrateEntity=function(){if(s="migrateEntity","paused"==a)return!1;showClearShop(!1),sendAjaxRequestStore({controller:l,func:"migrate"}).done(function(e){var t;e.error&&((t=c(e.error)).appendTo(r),r.slideDown(),setTimeout(function(){t.slideUp(400,function(){t.remove(),r.is(":empty")&&r.slideUp()})},1e4)),"success"==e.result?indexShop():"continue"==e.result?(displayReponse(e.process.entity,e.process.percent,e.process.migrated,e.process.error,e.process.finish),migrateEntity()):(setIsRunningState(!1),c("#ncwm-migrate-stuck").slideDown(),autoRetry())}).fail(function(e){r.empty(),r.html(e.responseText),r.slideDown(),setIsRunningState(!1),c("#ncwm-migrate-stuck").slideDown(),autoRetry()})},c("#settings-switch").click(function(e){e.preventDefault(),n.addClass("fade-in")}),c("#settings .close, #settings").click(function(e){e.preventDefault(),n.removeClass("fade-in")}),c(".settings-content").click(function(e){e.stopPropagation()}),c("#reset-button").click(function(e){e.preventDefault(),c('#settings-form input[name="tax"]').val("4"),c('#settings-form input[name="manufacturer"]').val("4"),c('#settings-form input[name="category"]').val("4"),c('#settings-form input[name="product"]').val("4"),c('#settings-form input[name="customer"]').val("4"),c('#settings-form input[name="order"]').val("4"),c('#settings-form input[name="review"]').val("4"),c('#settings-form input[name="srcprefix"]').val(""),c('#settings-form input[name="tgprefix"]').val("")}),c("#ncwm-setup-submit").click(function(e){e.preventDefault();var i=c(this);i.addClass("disable-a");var t=!1;if(c("#ncwm-setup-form input.must_url").each(function(){isUrl(c(this).val())||(c(this).next("span.error-url").length<1&&c(this).after('<span class="error error-url">Please enter a valid URL starting with "http://" or "https://"</span>'),t=!0)}),t)return i.removeClass("disable-a"),!1;var s=i.html(),n=i.data("loading-text");i.html(n);var a=c("#ncwm-setup-form").serialize()+"&controller="+l+"&action=ncwm_migration";sendAjaxRequestStore(a).done(function(e){i.html(s),i.removeClass("disable-a"),"success"==e.result?(changeTab("next"),r.slideUp(),r.empty(),i.hide(),c("#ncwm-config-submit").show(),c("#ncwm-process-child-setup").hide(),c("#ncwm-process-child-config").html(e.html),c("#ncwm-process-child-config").show()):(r.html(e.error),r.slideDown())}).fail(function(e,t,n){r.empty(),r.html(e.responseText),r.slideDown(),i.html(s),i.removeClass("disable-a"),alert("Request timeout or server isn't responding, please reload the page.")})}),c(document).off("click","#ncwm-config-submit").on("click","#ncwm-config-submit",function(e){e.preventDefault();var i=c(this);i.addClass("disable-a");var t=!1,n=checkSelectEntity(),s=checkSeparateLang();if(!0===n&&!0===s||(t=!0,alert("Please correct the config sections highlighted in red")),t)return i.removeClass("disable-a"),!1;c(".ncwm-confirm-box-container").addClass("fade-in"),c(".ncwm-confirm-box-container .confirm-box .confirm").focus(),c(".ncwm-confirm-box-container .confirm-box .confirm").off("click").on("click",function(){c(".ncwm-confirm-box-container").removeClass("fade-in");var t=i.html(),e=i.data("loading-text");i.html(e);var n=c("#ncwm-config-form").serialize()+"&controller="+l+"&action=ncwm_migration";sendAjaxRequestStore(n).done(function(e){i.html(t),i.removeClass("disable-a"),"success"==e.result?(changeTab("next"),r.slideUp(),r.empty(),c("#ncwm-process-form-step").html(e.html),setIsRunningState(!0),"clear"==e.action?(i.hide(),clearShop()):"migrate"==e.action&&(i.hide(),migrateEntity())):(r.html(e.error),r.slideDown())}).fail(function(e){r.empty(),r.html(e.responseText),r.slideDown(),i.html(t),i.removeClass("disable-a"),alert("Request timeout or server isn't responding, please reload the page.")})}),c(".ncwm-confirm-box-container, .confirm-box .cancel").off("click").on("click",function(){c(".ncwm-confirm-box-container").removeClass("fade-in"),i.removeClass("disable-a")}),c(".confirm-box").off("click").on("click",function(e){e.stopPropagation()})}),c(document).on("click","#migrate-resume",function(e){e.preventDefault();var t=c(this);t.addClass("disable-a");var n=c("#setup-submit"),i=t.html(),s=t.data("loading-text");t.html(s),sendAjaxRequestApp({controller:l,func:"resume"}).done(function(e){t.html(i),t.removeClass("disable-a"),"success"==e.result?(changeTab("next"),changeTab("next"),r.slideUp(),r.empty(),c("#process-form-step").html(e.html),setIsRunningState(!0),"clear"==e.action?(n.hide(),clearShop()):"migrate"==e.action?(n.hide(),migrateEntity()):"reindex"==e.action&&(n.hide(),indexShop())):(r.html(e.error),r.slideDown())}).fail(function(e){r.empty(),r.html(e.responseText),r.slideDown(),t.html(i),t.removeClass("disable-a"),alert("Request timeout or server isn't responding, please reload the page.")})}),c(document).on("click","#file-upload",function(e){e.preventDefault();var t=c(this),n=c("#setup-submit");t.addClass("disable-a"),n.addClass("disable-a");var i=t.html(),s=t.data("loading-text");t.html(s);var a=c('#setup-form select[name="source_type"]').val();c("#file-upload-form .uploading-fail").slideUp(),c("#file-upload-form .uploading-success").slideUp();var o=new FormData;c.each(c('#file-upload-form input[type="file"]'),function(e,t){o.append(c(t).attr("name"),t.files[0])}),o.append("controller",l),o.append("action","upload"),o.append("source_type",a),showUploading(!0),c.ajax({url:nc_ajax_params.url,type:"POST",data:o,processData:!1,contentType:!1,dataType:"json"}).done(function(e){t.html(i),"success"==e.result?(r.slideUp(),r.empty(),showUploading(!1),showInserting(!0),insertData()):(r.html(e.error),r.slideDown(),t.removeClass("disable-a"),n.removeClass("disable-a"),showUploading(!1),c("#file-upload-form .uploading-fail").slideDown())}).fail(function(e){r.empty(),r.html(e.responseText),r.slideDown(),t.html(i),t.removeClass("disable-a"),n.removeClass("disable-a"),showUploading(!1),c("#file-upload-form .uploading-fail").slideDown(),alert("Request timeout or server isn't responding, please reload the page.")})}),c(document).on("click","#ncwm-migrate-try-again, .migration-loading.paused",function(e){e.preventDefault(),e.isTrigger||(o=3,clearTimeout(t)),r.slideUp(),r.empty(),c("#ncwm-migrate-stuck").slideUp(),setIsRunningState(!0),window[s]()}),c(document).on("click","#ncwm-go-back-button",function(e){e.preventDefault(),changeTab("back"),c("#ncwm-config-submit").hide(),c("#ncwm-setup-submit").show(),c("#ncwm-process-child-config").hide(),c("#ncwm-process-child-config").empty(),c("#ncwm-process-child-setup").show()}),c(document).on("click",".section-title",function(e){e.preventDefault();var t=c(this),n=c(this).next(".list-field");t.hasClass("collapsed")?(t.removeClass("collapsed"),n.slideDown()):(t.addClass("collapsed"),n.slideUp())}),c(document).on("click",".list-entities .checkbox-all",function(){c('.list-entities input[type="checkbox"]').prop("checked",this.checked)}),c(document).on("click",'.list-entities .level-1 input[type="checkbox"]',function(){this.checked||c(".list-entities .checkbox-all").prop("checked",!1)}),c(document).on("click",'.list-entities .level-2 input[name="reviews"]',function(){this.checked&&c('.list-entities .level-1 input[name="products"]').prop("checked",!0)}),c(document).on("input","#ncwm-setup-form input.must_url",function(){var e=c(this),t=e.val();isUrl(t)&&(e.next("span.error-url").remove(),"source_url"==e.attr("name")?c("#source_kit_url").attr("href",t+"/kitconnect/kitconnect.php"):"target_url"==e.attr("name")&&c("#target_kit_url").attr("href",t+"/kitconnect/kitconnect.php"))}),c(document).on("change",".cart-select",function(e){e.stopImmediatePropagation();var t=c(this),n=t.val();t.prop("disabled",!0);var i=t.data("type"),s=c(".ncwm-setup-loader");s.addClass("blurloading"),sendAjaxRequestStore({controller:l,func:"changecart",type:i,cart_type:n}).done(function(e){e.html?(c("."+i+"-area .dynamic-group").html(e.html),c("."+i+"-area input.must_url").trigger("input")):c("."+i+"-area .dynamic-group").html('<div class="ncwm-form-field"><span class="error error-cart">Invalid cart type! Please select your cart again!</span></div>'),t.prop("disabled",!1),s.removeClass("blurloading")}).fail(function(){alert("Request timeout or server isn't responding, please reload the page."),t.prop("disabled",!1),s.removeClass("blurloading")})}),c(document).on("click",".migration-loading:not(.paused)",function(){setIsRunningState(!1)}),c(document).on({mouseenter:function(){c("body").append('<div class="tooltip-container"><div class="tooltip-description">'+c(this).data("description")+"</div></div>");var e=c(".tooltip-container"),t=c(this).offset();e.css({top:t.top,left:t.left+15}).fadeIn(),e.mouseleave(function(){setTimeout(function(){c(".tooltip-container:hover").length||e.remove()},200)})},mouseleave:function(){var e=c(".tooltip-container");setTimeout(function(){c(".tooltip-container:hover").length||e.remove()},200)}},".hover-detail"),c(document).on({mouseenter:function(){c(".source-target-field > i:visible").each(function(){"running"==a?c(this).addClass("pause"):c(this).removeClass("pause")})},mouseleave:function(){c(".source-target-field > i:visible").each(function(){"running"==a?c(this).removeClass("pause"):c(this).addClass("pause")})}},"#ncwm-migration-loading"),c(document).ready(function(){var e=c('.source-area input[name="source_url"]').val();isUrl(e)&&c("#source_kit_url").attr("href",e+"/kitconnect/kitconnect.php");var t=c('.target-area input[name="target_url"]').val();isUrl(t)&&c("#target_kit_url").attr("href",t+"/kitconnect/kitconnect.php"),c("#ncwm-cart-select").selectpicker("refresh")}),c(document).on("click touchend",function(e){c(e.target).is(".server-location")||c(".server-location .collapse").collapse("hide")})});